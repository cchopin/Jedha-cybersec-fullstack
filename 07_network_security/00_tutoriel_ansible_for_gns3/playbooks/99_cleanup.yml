---
# ============================================
# PLAYBOOK : SUPPRESSION DU LAB
# ============================================
# Ce playbook supprime :
# - Tous les nodes du projet
# - Le projet GNS3
#
# Usage: ansible-playbook playbooks/99_cleanup.yml
# ============================================

- name: "Suppression du lab tutoriel"
  hosts: localhost
  gather_facts: false

  tasks:
    # ==========================================
    # PARTIE 1 : Trouver le projet
    # ==========================================
    - name: "1.1 - Recuperer les projets existants"
      uri:
        url: "{{ gns3_server }}/v2/projects"
        method: GET
      register: projects

    - name: "1.2 - Chercher notre projet"
      set_fact:
        existing_project: "{{ projects.json | selectattr('name', 'equalto', project_name) | list | first | default(none) }}"

    - name: "1.3 - Verifier que le projet existe"
      fail:
        msg: "Le projet '{{ project_name }}' n'existe pas."
      when: existing_project is none

    - name: "Afficher le projet trouve"
      debug:
        msg: "Projet trouve: {{ project_name }} (ID: {{ existing_project.project_id }})"

    # ==========================================
    # PARTIE 2 : Arreter et supprimer les nodes
    # ==========================================
    - name: "2.1 - Ouvrir le projet"
      uri:
        url: "{{ gns3_server }}/v2/projects/{{ existing_project.project_id }}/open"
        method: POST
        status_code: [200, 201]
      ignore_errors: true

    - name: "2.2 - Arreter tous les nodes"
      uri:
        url: "{{ gns3_server }}/v2/projects/{{ existing_project.project_id }}/nodes/stop"
        method: POST
        status_code: [200, 204]
      ignore_errors: true

    - name: "2.3 - Attendre l'arret des nodes"
      pause:
        seconds: 5
        prompt: "Arret des nodes en cours..."

    # ==========================================
    # PARTIE 3 : Fermer et supprimer le projet
    # ==========================================
    - name: "3.1 - Fermer le projet"
      uri:
        url: "{{ gns3_server }}/v2/projects/{{ existing_project.project_id }}/close"
        method: POST
        status_code: [200, 201, 204]
      ignore_errors: true

    - name: "3.2 - Supprimer le projet"
      uri:
        url: "{{ gns3_server }}/v2/projects/{{ existing_project.project_id }}"
        method: DELETE
        status_code: [200, 204]
      register: delete_result

    - name: "Projet supprime avec succes"
      debug:
        msg:
          - "============================================"
          - "NETTOYAGE TERMINE"
          - "============================================"
          - "Projet '{{ project_name }}' supprime."
          - "============================================"

    # ==========================================
    # PARTIE 4 : Nettoyer les fichiers locaux
    # ==========================================
    - name: "4.1 - Supprimer switch_info.yml"
      file:
        path: "{{ playbook_dir }}/../switch_info.yml"
        state: absent
      ignore_errors: true
