# =============================================================================
# 05_rstp.yml - Rapid Spanning Tree Protocol (RSTP)
# =============================================================================
# RSTP (802.1w) est une amélioration de STP (802.1D) avec :
# - Convergence plus rapide (quelques secondes vs 30-50 secondes)
# - Nouveaux rôles de ports (Alternate, Backup)
# - Moins d'états de ports
#
# Comparaison STP vs RSTP :
# ┌─────────────────┬───────────────────┬────────────────────┐
# │                 │ STP (802.1D)      │ RSTP (802.1w)      │
# ├─────────────────┼───────────────────┼────────────────────┤
# │ Convergence     │ 30-50 secondes    │ < 10 secondes      │
# │ États ports     │ 5 (Blk,Lis,Lrn,   │ 3 (Discarding,     │
# │                 │    Fwd,Dis)       │    Learning,Fwd)   │
# │ Rôles ports     │ Root, Designated  │ Root, Designated,  │
# │                 │                   │ Alternate, Backup  │
# └─────────────────┴───────────────────┴────────────────────┘
# =============================================================================

---
- name: Configuration Rapid Spanning Tree Protocol (RSTP)
  hosts: localhost
  gather_facts: false

  vars_files:
    - ../switch_info.yml

  tasks:

    # =========================================================================
    # THÉORIE : STP vs RSTP
    # =========================================================================

    - name: "THÉORIE - Pourquoi RSTP ?"
      debug:
        msg: |
          ============================================================
          RAPID SPANNING TREE PROTOCOL (RSTP) - 802.1w
          ============================================================

          PROBLÈME avec STP classique :
          - Convergence lente : 30-50 secondes
          - Pendant ce temps, pas de trafic sur les ports en transition
          - Problématique pour les applications sensibles

          SOLUTION : RSTP
          - Convergence en quelques secondes
          - Mécanisme de "proposal/agreement" pour négocier rapidement
          - Compatible avec STP classique (interopérabilité)

          COMPARAISON des états :
          ┌────────────────┬──────────────────┐
          │ STP classique  │ RSTP             │
          ├────────────────┼──────────────────┤
          │ Disabled       │ Discarding       │
          │ Blocking       │ Discarding       │
          │ Listening      │ Discarding       │
          │ Learning       │ Learning         │
          │ Forwarding     │ Forwarding       │
          └────────────────┴──────────────────┘

          Mode Cisco : rapid-pvst (Rapid Per-VLAN Spanning Tree)
          ============================================================

    # =========================================================================
    # ÉTAT AVANT : STP classique
    # =========================================================================

    - name: "Vérifier le mode STP actuel"
      script: >
        ../scripts/cisco_cli.py
        --host {{ gns3_host }}
        --port {{ switches_info[0].console_port }}
        --show "show spanning-tree summary"
      args:
        executable: python3
      register: stp_mode_before

    - name: "AVANT - Mode STP actuel"
      debug:
        msg: |
          ============================================================
          MODE STP AVANT MODIFICATION
          ============================================================
          {{ stp_mode_before.stdout }}

          Le mode par défaut est généralement "ieee" (STP classique)
          ou "pvst" (Per-VLAN Spanning Tree)
          ============================================================

    # =========================================================================
    # CONFIGURATION : Passer en RSTP
    # =========================================================================

    - name: "Configuration RSTP sur tous les switches"
      debug:
        msg: |
          ============================================================
          CONFIGURATION RSTP
          ============================================================
          Commande Cisco : spanning-tree mode rapid-pvst

          Cette commande :
          - Active RSTP sur tous les VLANs
          - Permet une convergence plus rapide
          - Est compatible avec les switches STP classiques
          ============================================================

    - name: "Activer RSTP sur SW1"
      script: >
        ../scripts/cisco_cli.py
        --host {{ gns3_host }}
        --port {{ switches_info[0].console_port }}
        --commands "enable;configure terminal;spanning-tree mode rapid-pvst;end;write memory"
      args:
        executable: python3

    - name: "Activer RSTP sur SW2"
      script: >
        ../scripts/cisco_cli.py
        --host {{ gns3_host }}
        --port {{ switches_info[1].console_port }}
        --commands "enable;configure terminal;spanning-tree mode rapid-pvst;end;write memory"
      args:
        executable: python3

    - name: "Activer RSTP sur SW3"
      script: >
        ../scripts/cisco_cli.py
        --host {{ gns3_host }}
        --port {{ switches_info[2].console_port }}
        --commands "enable;configure terminal;spanning-tree mode rapid-pvst;end;write memory"
      args:
        executable: python3

    - name: "Attendre la convergence RSTP"
      pause:
        seconds: 10
        prompt: |
          Attente de la convergence RSTP...
          (beaucoup plus rapide que STP classique!)

    # =========================================================================
    # VÉRIFICATION : RSTP activé
    # =========================================================================

    - name: "Vérifier le nouveau mode"
      script: >
        ../scripts/cisco_cli.py
        --host {{ gns3_host }}
        --port {{ item.console_port }}
        --show "show spanning-tree vlan 1"
      args:
        executable: python3
      loop: "{{ switches_info }}"
      register: rstp_status
      loop_control:
        label: "{{ item.name }}"

    - name: "APRÈS - Mode RSTP activé"
      debug:
        msg: |
          ============================================================
          {{ item.item.name }} - RSTP
          ============================================================
          {{ item.stdout }}
      loop: "{{ rstp_status.results }}"
      loop_control:
        label: "{{ item.item.name }}"

    # =========================================================================
    # FONCTIONNALITÉS RSTP AVANCÉES
    # =========================================================================

    - name: "FONCTIONNALITÉS RSTP"
      debug:
        msg: |
          ============================================================
          FONCTIONNALITÉS RSTP AVANCÉES
          ============================================================

          1. EDGE PORTS (PortFast) :
             - Ports connectés à des hôtes (pas des switches)
             - Passent directement en Forwarding
             - Commande : spanning-tree portfast edge

          2. LINK TYPE :
             - Point-to-point : Lien full-duplex entre 2 switches
             - Shared : Lien half-duplex (hub)
             - Commande : spanning-tree link-type point-to-point

          3. BPDU GUARD :
             - Désactive un port s'il reçoit un BPDU
             - Protection contre les switches non autorisés
             - Commande : spanning-tree bpduguard enable

          4. ROOT GUARD :
             - Empêche un port de devenir Root Port
             - Protection contre les changements de topologie
             - Commande : spanning-tree guard root

          Exemple de configuration sécurisée :
          interface range ethernet 1/0 - 3
            spanning-tree portfast edge
            spanning-tree bpduguard enable
          ============================================================

    # =========================================================================
    # RÉSUMÉ
    # =========================================================================

    - name: "RÉSUMÉ FINAL"
      debug:
        msg: |
          ============================================================
          RÉSUMÉ - RSTP CONFIGURÉ
          ============================================================

          Ce qui a été fait :
          1. Activé "rapid-pvst" sur les 3 switches
          2. La convergence est maintenant beaucoup plus rapide

          Points clés CCNA :
          - RSTP (802.1w) remplace STP (802.1D)
          - Convergence : secondes au lieu de 30-50 sec
          - Rétrocompatible avec STP classique
          - Commande Cisco : spanning-tree mode rapid-pvst

          Commandes de vérification :
          - show spanning-tree summary
          - show spanning-tree vlan 1
          - show spanning-tree interface <if> detail

          Pour revenir en STP classique :
            spanning-tree mode pvst
          ============================================================
