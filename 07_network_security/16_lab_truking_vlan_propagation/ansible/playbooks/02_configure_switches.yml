---
# Playbook pour configurer les VLANs et Trunk sur les switches
- name: Configurer les switches (VLANs + Trunk)
  hosts: localhost
  gather_facts: false

  vars_files:
    - ../switch_info.yml

  tasks:
    - name: Configurer SW1
      script: >
        ../scripts/configure_switch.py
        --host {{ gns3_host }}
        --port {{ sw1_console_port }}
        --hostname SW1
        --vlans '{{ vlans | to_json }}'
        --trunk-interface {{ trunk_interface }}
        --trunk-vlans "{{ trunk_allowed_vlans }}"
        --native-vlan {{ native_vlan }}
      args:
        executable: python3
      register: sw1_config

    - name: Afficher résultat SW1
      debug:
        var: sw1_config.stdout_lines

    - name: Configurer SW2
      script: >
        ../scripts/configure_switch.py
        --host {{ gns3_host }}
        --port {{ sw2_console_port }}
        --hostname SW2
        --vlans '{{ vlans | to_json }}'
        --trunk-interface {{ trunk_interface }}
        --trunk-vlans "{{ trunk_allowed_vlans }}"
        --native-vlan {{ native_vlan }}
      args:
        executable: python3
      register: sw2_config

    - name: Afficher résultat SW2
      debug:
        var: sw2_config.stdout_lines

    - name: Résumé de la configuration
      debug:
        msg: |
          ========================================
          CONFIGURATION TERMINÉE
          ========================================
          VLANs créés: {% for v in vlans %}{{ v.id }} ({{ v.name }}){% if not loop.last %}, {% endif %}{% endfor %}

          Trunk configuré sur {{ trunk_interface }}:
            - Encapsulation: 802.1Q
            - VLANs autorisés: {{ trunk_allowed_vlans }}
            - Native VLAN: {{ native_vlan }}

          Pour vérifier:
            telnet {{ gns3_host }} {{ sw1_console_port }}
            > show vlan brief
            > show interfaces trunk
          ========================================
