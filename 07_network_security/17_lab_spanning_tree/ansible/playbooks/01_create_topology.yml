# =============================================================================
# 01_create_topology.yml - Création de la topologie STP dans GNS3
# =============================================================================
# Ce playbook crée une topologie en triangle pour étudier STP :
#
#          SW1
#         /   \
#       SW2---SW3
#
# La boucle créée forcera STP à bloquer un port !
# =============================================================================

---
- name: Créer la topologie Spanning Tree dans GNS3
  hosts: localhost
  gather_facts: false # Pas besoin des facts système

  # ---------------------------------------------------------------------------
  # TÂCHES DU PLAYBOOK
  # ---------------------------------------------------------------------------
  tasks:
    # =========================================================================
    # ÉTAPE 1 : Ouvrir le projet GNS3
    # =========================================================================
    # L'API GNS3 nécessite que le projet soit "ouvert" avant de le modifier
    # =========================================================================
    - name: "STEP 1 - Ouvrir le projet GNS3"
      uri:
        url: "{{ gns3_server }}/v2/projects/{{ project_id }}/open"
        method: POST
        status_code: [200, 201] # 200=déjà ouvert, 201=vient d'ouvrir
      register: project_info

    - name: "Afficher infos projet"
      debug:
        msg: "Projet ouvert: {{ project_info.json.name }}"

    # =========================================================================
    # ÉTAPE 2 : Nettoyer les nodes existants
    # =========================================================================
    # On supprime tout pour repartir de zéro (évite les conflits)
    # =========================================================================
    - name: "STEP 2 - Récupérer les nodes existants"
      uri:
        url: "{{ gns3_server }}/v2/projects/{{ project_id }}/nodes"
        method: GET
      register: existing_nodes

    - name: "Supprimer les nodes existants"
      uri:
        url: "{{ gns3_server }}/v2/projects/{{ project_id }}/nodes/{{ item.node_id }}"
        method: DELETE
        status_code: [200, 204]
      loop: "{{ existing_nodes.json }}"
      when: existing_nodes.json | length > 0
      loop_control:
        label: "{{ item.name }}" # Affiche juste le nom dans les logs

    # =========================================================================
    # ÉTAPE 3 : Créer les 3 switches
    # =========================================================================
    # On utilise le template IOU L2 pour créer chaque switch
    # Les positions x,y sont définies dans group_vars/all.yml
    # =========================================================================
    - name: "STEP 3 - Créer les switches IOU L2"
      uri:
        url: "{{ gns3_server }}/v2/projects/{{ project_id }}/templates/{{ template_iou_l2_id }}"
        method: POST
        body_format: json
        body:
          name: "{{ item.name }}"
          x: "{{ item.x }}"
          y: "{{ item.y }}"
        status_code: [200, 201]
      loop: "{{ switches }}"
      register: created_switches
      loop_control:
        label: "{{ item.name }}"

    # Afficher les switches créés avec leurs ports console
    - name: "Afficher les switches créés"
      debug:
        msg: >
          Switch {{ item.json.name }} créé
          - Node ID: {{ item.json.node_id }}
          - Console: telnet {{ gns3_host }} {{ item.json.console }}
      loop: "{{ created_switches.results }}"
      loop_control:
        label: "{{ item.json.name }}"

    # =========================================================================
    # ÉTAPE 4 : Sauvegarder les node_ids pour les liens
    # =========================================================================
    # On extrait les IDs des switches pour les utiliser lors de la création
    # des liens
    # =========================================================================
    - name: "STEP 4 - Extraire les node IDs"
      set_fact:
        switch_nodes: "{{ created_switches.results | map(attribute='json') | list }}"

    - name: "Debug - Afficher les node IDs"
      debug:
        msg: "{{ item.name }}: {{ item.node_id }}"
      loop: "{{ switch_nodes }}"
      loop_control:
        label: "{{ item.name }}"

    # =========================================================================
    # ÉTAPE 5 : Créer les liens (topologie en triangle)
    # =========================================================================
    # Chaque lien connecte 2 switches via leurs ports Ethernet
    # Format API GNS3 : nodes[0] et nodes[1] avec adapter_number et port_number
    # =========================================================================
    - name: "STEP 5 - Créer les liens entre switches"
      uri:
        url: "{{ gns3_server }}/v2/projects/{{ project_id }}/links"
        method: POST
        body_format: json
        body:
          nodes:
            - adapter_number: "{{ item.from_adapter }}"
              node_id: "{{ switch_nodes[item.from_switch].node_id }}"
              port_number: "{{ item.from_port }}"
            - adapter_number: "{{ item.to_adapter }}"
              node_id: "{{ switch_nodes[item.to_switch].node_id }}"
              port_number: "{{ item.to_port }}"
        status_code: [200, 201]
      loop: "{{ links }}"
      register: created_links
      loop_control:
        label: "{{ item.name }}"

    - name: "Afficher les liens créés"
      debug:
        msg: "Lien {{ item.item.name }} créé - Link ID: {{ item.json.link_id }}"
      loop: "{{ created_links.results }}"
      loop_control:
        label: "{{ item.item.name }}"

    # =========================================================================
    # ÉTAPE 6 : Démarrer tous les switches
    # =========================================================================
    - name: "STEP 6 - Démarrer tous les nodes"
      uri:
        url: "{{ gns3_server }}/v2/projects/{{ project_id }}/nodes/start"
        method: POST
        status_code: [200, 204]

    - name: "Attendre le démarrage des switches"
      pause:
        seconds: 30
        prompt: |
          Attente du boot des switches IOU...
          (30 secondes pour que les switches démarrent complètement)

    # =========================================================================
    # ÉTAPE 7 : Sauvegarder les infos de connexion
    # =========================================================================
    # On sauvegarde les ports console dans un fichier pour les autres playbooks
    # =========================================================================
    - name: "STEP 7 - Sauvegarder les infos des switches"
      copy:
        content: |
          # Fichier généré automatiquement par 01_create_topology.yml
          # Contient les ports console des switches pour les autres playbooks

          switches_info:
          {% for sw in switch_nodes %}
            - name: "{{ sw.name }}"
              node_id: "{{ sw.node_id }}"
              console_port: {{ sw.console }}
              console_cmd: "telnet {{ gns3_host }} {{ sw.console }}"
          {% endfor %}
        dest: "{{ playbook_dir }}/../switch_info.yml"

    # =========================================================================
    # RÉSUMÉ FINAL
    # =========================================================================
    - name: "RÉSUMÉ - Topologie créée"
      debug:
        msg: |
          ============================================================
          TOPOLOGIE STP CRÉÉE AVEC SUCCÈS
          ============================================================

          Switches créés:
          {% for sw in switch_nodes %}
            - {{ sw.name }}: telnet {{ gns3_host }} {{ sw.console }}
          {% endfor %}

          Topologie:
                    SW1
                   /   \
                 SW2---SW3

          Liens:
            - SW1 (e0/0) <---> SW2 (e0/0)
            - SW1 (e0/1) <---> SW3 (e0/0)
            - SW2 (e0/1) <---> SW3 (e0/1)

          IMPORTANT: STP va bloquer un port pour éviter la boucle!

          Prochaine étape:
            ansible-playbook playbooks/02_configure_stp.yml
          ============================================================
