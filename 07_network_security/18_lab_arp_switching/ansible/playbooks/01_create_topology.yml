---
# =============================================================================
# Playbook pour créer un NOUVEAU projet GNS3 et la topologie
# =============================================================================
# Topologie créée:
#   +-------+                    +-------+
#   |  SW1  | e0/0 ----trunk---- |  SW2  | e0/0
#   +-------+                    +-------+
#      │                            │
#      ├── VLAN 10 (192.168.10.1)   ├── VLAN 10 (192.168.10.2)
#      ├── VLAN 20 (192.168.20.1)   ├── VLAN 20 (192.168.20.2)
#      └── VLAN 30 (192.168.30.1)   └── VLAN 30 (192.168.30.2)
# =============================================================================

- name: Créer un nouveau projet GNS3 pour le lab ARP/Switching
  hosts: localhost
  gather_facts: false

  vars:
    project_name: "Lab_ARP_Switching"

  tasks:
    # =========================================================================
    # ÉTAPE 1: Créer un nouveau projet GNS3
    # =========================================================================
    - name: "ÉTAPE 1: Créer un nouveau projet GNS3"
      uri:
        url: "{{ gns3_server }}/v2/projects"
        method: POST
        body_format: json
        body:
          name: "{{ project_name }}"
          auto_close: false
          auto_open: true
          auto_start: false
        status_code: [200, 201]
      register: new_project

    - name: Afficher le projet créé
      debug:
        msg: |
          ============================================
          NOUVEAU PROJET GNS3 CRÉÉ
          ============================================
          Nom: {{ new_project.json.name }}
          Project ID: {{ new_project.json.project_id }}
          ============================================

    - name: Sauvegarder le project_id
      set_fact:
        project_id: "{{ new_project.json.project_id }}"

    # =========================================================================
    # ÉTAPE 2: Ouvrir le projet
    # =========================================================================
    - name: "ÉTAPE 2: Ouvrir le projet"
      uri:
        url: "{{ gns3_server }}/v2/projects/{{ project_id }}/open"
        method: POST
        status_code: [200, 201]
      register: project_info

    # =========================================================================
    # ÉTAPE 3: Créer les switches
    # =========================================================================
    - name: "ÉTAPE 3: Créer les switches IOU L2"
      uri:
        url: "{{ gns3_server }}/v2/projects/{{ project_id }}/templates/{{ template_iou_l2_id }}"
        method: POST
        body_format: json
        body:
          name: "{{ item.name }}"
          x: "{{ item.x }}"
          y: "{{ item.y }}"
        status_code: [200, 201]
      loop: "{{ switches }}"
      register: created_switches

    - name: Afficher les switches créés
      debug:
        msg: "Switch {{ item.json.name }} créé - Node ID: {{ item.json.node_id }} - Console port: {{ item.json.console }}"
      loop: "{{ created_switches.results }}"

    # =========================================================================
    # ÉTAPE 4: Sauvegarder les node_ids pour le link
    # =========================================================================
    - name: Set node IDs
      set_fact:
        sw1_node_id: "{{ created_switches.results[0].json.node_id }}"
        sw2_node_id: "{{ created_switches.results[1].json.node_id }}"
        sw1_console_port: "{{ created_switches.results[0].json.console }}"
        sw2_console_port: "{{ created_switches.results[1].json.console }}"

    # =========================================================================
    # ÉTAPE 5: Créer le lien trunk entre les switches
    # =========================================================================
    - name: "ÉTAPE 5: Créer le lien trunk entre SW1 et SW2"
      uri:
        url: "{{ gns3_server }}/v2/projects/{{ project_id }}/links"
        method: POST
        body_format: json
        body:
          nodes:
            - adapter_number: 0
              node_id: "{{ sw1_node_id }}"
              port_number: 0
            - adapter_number: 0
              node_id: "{{ sw2_node_id }}"
              port_number: 0
        status_code: [200, 201]
      register: trunk_link

    - name: Afficher le lien créé
      debug:
        msg: "Lien trunk créé - Link ID: {{ trunk_link.json.link_id }}"

    # =========================================================================
    # ÉTAPE 6: Démarrer les switches
    # =========================================================================
    - name: "ÉTAPE 6: Démarrer tous les nodes"
      uri:
        url: "{{ gns3_server }}/v2/projects/{{ project_id }}/nodes/start"
        method: POST
        status_code: [200, 204]

    - name: Attendre que les switches démarrent
      pause:
        seconds: 30
        prompt: "Attente du boot des switches IOU (30s)..."

    # =========================================================================
    # ÉTAPE 7: Sauvegarder les infos pour les autres playbooks
    # =========================================================================
    - name: "ÉTAPE 7: Sauvegarder les infos du projet et des switches"
      copy:
        content: |
          # Généré automatiquement par 01_create_topology.yml
          # Projet: {{ project_name }}
          project_id: "{{ project_id }}"
          sw1_console_port: {{ sw1_console_port }}
          sw2_console_port: {{ sw2_console_port }}
          sw1_node_id: "{{ sw1_node_id }}"
          sw2_node_id: "{{ sw2_node_id }}"
        dest: "{{ playbook_dir }}/../switch_info.yml"

    - name: Résumé
      debug:
        msg: |
          ========================================
          PROJET GNS3 ET TOPOLOGIE CRÉÉS
          ========================================
          Projet: {{ project_name }}
          Project ID: {{ project_id }}

          SW1 - Console: telnet {{ gns3_host }} {{ sw1_console_port }}
          SW2 - Console: telnet {{ gns3_host }} {{ sw2_console_port }}

          Lien trunk: SW1 (e0/0) <---> SW2 (e0/0)

          Lancez maintenant:
            ansible-playbook -i inventory.yml playbooks/02_configure_switches.yml
          ========================================
