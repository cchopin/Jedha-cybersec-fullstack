---
# =============================================================================
# Lab 21: STP Role Identification
# Playbook 01: Creation de la topologie GNS3
# =============================================================================
# Ce playbook cree:
# - 3 switches IOU L2 en TRIANGLE (Switch1, Switch2, Switch3)
# - 3 VPCs (un par switch, tous dans VLAN 10)
# - Liens trunk entre les switches (topologie en triangle)
# =============================================================================

- name: Creer la topologie STP Lab
  hosts: localhost
  gather_facts: false

  tasks:
    # =========================================================================
    # ETAPE 0: Recuperer les templates GNS3
    # =========================================================================
    - name: "ETAPE 0: Recuperer la liste des templates GNS3"
      uri:
        url: "{{ gns3_server }}/v2/templates"
        method: GET
        return_content: true
      register: templates_response

    - name: Extraire l'ID du template IOU L2
      set_fact:
        template_iou_l2_id: "{{ templates_response.json | selectattr('name', 'equalto', 'Cisco IOU L2') | map(attribute='template_id') | first }}"

    - name: Extraire l'ID du template VPCS
      set_fact:
        template_vpcs_id: "{{ templates_response.json | selectattr('name', 'equalto', 'VPCS') | map(attribute='template_id') | first }}"

    - name: Afficher les templates trouves
      debug:
        msg: |
          Templates GNS3:
          - IOU L2: {{ template_iou_l2_id }}
          - VPCS: {{ template_vpcs_id }}

    # =========================================================================
    # ETAPE 1: Creer ou recuperer le projet
    # =========================================================================
    - name: "ETAPE 1: Recuperer les projets existants"
      uri:
        url: "{{ gns3_server }}/v2/projects"
        method: GET
        return_content: true
      register: existing_projects

    - name: Verifier si le projet existe
      set_fact:
        project_exists: "{{ existing_projects.json | selectattr('name', 'equalto', project_name) | list | length > 0 }}"

    - name: Recuperer le projet existant
      set_fact:
        project_id: "{{ (existing_projects.json | selectattr('name', 'equalto', project_name) | first).project_id }}"
      when: project_exists

    - name: Creer le projet GNS3
      uri:
        url: "{{ gns3_server }}/v2/projects"
        method: POST
        body_format: json
        body:
          name: "{{ project_name }}"
          auto_close: false
        status_code: [200, 201]
      register: new_project
      when: not project_exists

    - name: Definir project_id pour nouveau projet
      set_fact:
        project_id: "{{ new_project.json.project_id }}"
      when: not project_exists

    - name: Ouvrir le projet
      uri:
        url: "{{ gns3_server }}/v2/projects/{{ project_id }}/open"
        method: POST
        status_code: [200, 201]

    - name: Afficher le projet
      debug:
        msg: "Projet: {{ project_name }} ({{ project_id }})"

    # =========================================================================
    # ETAPE 2: Recuperer les nodes existants
    # =========================================================================
    - name: "ETAPE 2: Recuperer les nodes existants"
      uri:
        url: "{{ gns3_server }}/v2/projects/{{ project_id }}/nodes"
        method: GET
        return_content: true
      register: existing_nodes

    - name: Liste des nodes existants
      set_fact:
        existing_node_names: "{{ existing_nodes.json | map(attribute='name') | list }}"

    # =========================================================================
    # ETAPE 3: Creer les switches
    # =========================================================================
    - name: "ETAPE 3: Creer les switches IOU L2"
      uri:
        url: "{{ gns3_server }}/v2/projects/{{ project_id }}/templates/{{ template_iou_l2_id }}"
        method: POST
        body_format: json
        body:
          name: "{{ item.name }}"
          x: "{{ item.x }}"
          y: "{{ item.y }}"
        status_code: [200, 201]
      loop: "{{ switches }}"
      when: item.name not in existing_node_names
      register: switches_created

    # =========================================================================
    # ETAPE 4: Creer les VPCs
    # =========================================================================
    - name: "ETAPE 4: Creer les VPCs"
      uri:
        url: "{{ gns3_server }}/v2/projects/{{ project_id }}/nodes"
        method: POST
        body_format: json
        body:
          name: "{{ item.name }}"
          node_type: "vpcs"
          compute_id: "local"
          x: "{{ item.x }}"
          y: "{{ item.y }}"
        status_code: [200, 201]
      loop: "{{ vpcs }}"
      when: item.name not in existing_node_names
      register: vpcs_created

    # =========================================================================
    # ETAPE 5: Recuperer tous les nodes
    # =========================================================================
    - name: "ETAPE 5: Recuperer tous les nodes"
      uri:
        url: "{{ gns3_server }}/v2/projects/{{ project_id }}/nodes"
        method: GET
        return_content: true
      register: all_nodes

    - name: Creer dictionnaire des nodes
      set_fact:
        nodes_dict: "{{ nodes_dict | default({}) | combine({item.name: item}) }}"
      loop: "{{ all_nodes.json }}"

    # =========================================================================
    # ETAPE 6: Creer les liens trunk entre switches (TRIANGLE)
    # =========================================================================
    - name: "ETAPE 6: Creer les liens trunk (topologie triangle)"
      uri:
        url: "{{ gns3_server }}/v2/projects/{{ project_id }}/links"
        method: POST
        body_format: json
        body:
          nodes:
            - adapter_number: "{{ item.adapter1 }}"
              node_id: "{{ nodes_dict[item.switch1].node_id }}"
              port_number: "{{ item.port1 }}"
            - adapter_number: "{{ item.adapter2 }}"
              node_id: "{{ nodes_dict[item.switch2].node_id }}"
              port_number: "{{ item.port2 }}"
        status_code: [200, 201, 409]
      loop: "{{ trunk_links }}"

    # =========================================================================
    # ETAPE 7: Creer les liens VPCs -> Switches
    # =========================================================================
    - name: "ETAPE 7: Connecter les VPCs aux switches"
      uri:
        url: "{{ gns3_server }}/v2/projects/{{ project_id }}/links"
        method: POST
        body_format: json
        body:
          nodes:
            - adapter_number: 0
              node_id: "{{ nodes_dict[item.name].node_id }}"
              port_number: 0
            - adapter_number: "{{ item.adapter }}"
              node_id: "{{ nodes_dict[item.switch].node_id }}"
              port_number: "{{ item.port }}"
        status_code: [200, 201, 409]
      loop: "{{ vpcs }}"

    # =========================================================================
    # ETAPE 8: Demarrer tous les nodes
    # =========================================================================
    - name: "ETAPE 8: Demarrer tous les nodes"
      uri:
        url: "{{ gns3_server }}/v2/projects/{{ project_id }}/nodes/start"
        method: POST
        status_code: [200, 204]

    - name: Attendre le demarrage
      pause:
        seconds: 90
        prompt: "Attente du demarrage des switches IOU (90s)..."

    # =========================================================================
    # ETAPE 9: Sauvegarder les infos de connexion
    # =========================================================================
    - name: "ETAPE 9: Recuperer les nodes avec ports console"
      uri:
        url: "{{ gns3_server }}/v2/projects/{{ project_id }}/nodes"
        method: GET
        return_content: true
      register: final_nodes

    - name: Sauvegarder switch_info.yml
      copy:
        content: |
          # Informations de connexion - Lab 21 STP Role Identification
          # Genere automatiquement

          project_id: "{{ project_id }}"

          {% for node in final_nodes.json | selectattr('node_type', 'equalto', 'iou') %}
          {{ node.name | lower | replace('-', '_') }}_console_port: {{ node.console }}
          {% endfor %}

          {% for node in final_nodes.json | selectattr('node_type', 'equalto', 'vpcs') %}
          {{ node.name | lower | replace('-', '_') }}_console_port: {{ node.console }}
          {% endfor %}
        dest: "{{ playbook_dir }}/../switch_info.yml"

    # =========================================================================
    # Resume
    # =========================================================================
    - name: Resume
      debug:
        msg: |
          ========================================
          TOPOLOGIE STP CREEE AVEC SUCCES
          ========================================

          Projet: {{ project_name }}

          TOPOLOGIE EN TRIANGLE:

                    Switch1
                   /       \
              Et0/0         Et0/1
                 /           \
            Switch2 ------- Switch3
                    Et0/1-Et0/0

          SWITCHES:
          {% for node in final_nodes.json | selectattr('node_type', 'equalto', 'iou') | sort(attribute='name') %}
            {{ node.name }}: telnet {{ gns3_host }} {{ node.console }}
          {% endfor %}

          VPCs:
          {% for node in final_nodes.json | selectattr('node_type', 'equalto', 'vpcs') | sort(attribute='name') %}
            {{ node.name }}: telnet {{ gns3_host }} {{ node.console }}
          {% endfor %}

          ========================================
          PROCHAINE ETAPE
          ========================================

          ansible-playbook playbooks/02_configure_vlans.yml

          ========================================
