# Exploitation et reconnaissance Linux

**Duree : 45 min**

## Ce que vous allez apprendre dans ce cours

Nous avons parle du systeme Linux et vu globalement comment il fonctionne, mais quel est le scenario d'attaque ? Dans cette lecon, vous allez :

- apprendre les bases de l'exploitation Linux et de l'elevation de privileges,
- decouvrir des techniques d'escalade classiques,
- vous familiariser avec les scanners d'elevation de privileges.

---

## Introduction a l'exploitation Linux

L'**exploitation Linux** designe le processus de tirer avantage des faiblesses ou des mauvaises configurations d'un systeme Linux pour obtenir un acces non autorise ou des privileges plus eleves.

### Scenarios d'attaque

**Obtenir un acces non autorise** : un attaquant reussit a se placer sur le meme reseau que votre machine. Il n'a pas encore acces mais cherche a entrer en exploitant la facon dont votre machine interagit avec le monde exterieur.

**Elevation de privileges (privilege escalation)** : un attaquant a trouve une vulnerabilite web et a acces a la machine avec un utilisateur peu privilegie (ex: l'utilisateur du serveur web). Il veut maintenant voir s'il peut s'executer en tant que root ou un autre utilisateur privilegie.

Ces vulnerabilites proviennent souvent de :
- Permissions mal configurees
- Services exposes
- Logiciels obsoletes
- Erreurs humaines

> **Important** : de nombreux exploits ne sont pas des zero-days avances. Les attaquants utilisent souvent des fonctionnalites legitimes de maniere non prevue. Les mauvaises configurations sudo, les scripts de sauvegarde oublies ou les anciens binaires setuid sont des points d'entree frequents.

### Post-exploitation

Une fois une vulnerabilite exploitee, les attaquants ont d'autres objectifs :
- **Persistence** : garder l'acces actif apres les redemarrages (cron jobs, binaires backdoores, cles SSH)
- **Exfiltration** : collecter et transferer silencieusement des donnees (scp, curl, canaux secrets)

---

## Techniques de reconnaissance et d'elevation de privileges

### Enumeration des utilisateurs

Quand un attaquant accede a un nouveau systeme, il doit d'abord determiner : qui suis-je ?

```bash
# Commandes de base
$ whoami
$ groups
$ id
```

**Enumerer les comptes utilisateurs :**
```bash
# Afficher uniquement les noms d'utilisateurs
$ cat /etc/passwd | cut -d: -f1

# Lister tous les utilisateurs et leurs groupes
$ for i in $(cut -d":" -f1 /etc/passwd 2>/dev/null);do id $i;done 2>/dev/null | sort
```

**Lister les utilisateurs avec acces console :**
```bash
$ cat /etc/passwd | grep "sh$"
```

**Decouvrir les superutilisateurs (UID 0) :**
```bash
$ awk -F: '($3 == "0") {print}' /etc/passwd
```

**Verifier les connexions :**
```bash
# Qui est connecte actuellement
$ who
$ w

# Historique des connexions
$ last -n 5
```

---

### Exploiter les groupes sudo et admin

Le groupe **sudo** (ou **admin**, **wheel**) determine les utilisateurs pouvant elever leurs privileges.

**Configuration par defaut typique :**
```
%sudo    ALL=(ALL:ALL) ALL
%admin   ALL=(ALL:ALL) ALL
```

Si vous connaissez le mot de passe d'un utilisateur de ce groupe :
```bash
$ sudo su
```

**Verifier les permissions sudo :**
```bash
$ sudo -l
```

#### Mauvaises configurations dangereuses

**NOPASSWD - Execution sans mot de passe :**
```
User user may run the following commands on this host:
   (root) NOPASSWD: /usr/bin/vim
```

Un attaquant pourrait obtenir un shell root avec :
```bash
$ sudo /usr/bin/vim -c ':!ls'
```

> **GTFOBins** : site web repertoriant les binaires Unix pouvant etre utilises pour contourner les restrictions de securite locales.

**SETENV - Manipulation des variables d'environnement :**
```
User waldo may run the following commands on this host:
    (ALL) SETENV: backup.py
```

Un attaquant peut creer son propre module Python malveillant et l'injecter :
```bash
$ sudo PYTHONPATH=/tmp/exploit backup.py
```

Autres variables manipulables : `LD_PRELOAD`, `LD_LIBRARY_PATH`

---

### Abuser des binaires SUID

Un binaire SUID qui execute des commandes shell sans restrictions peut etre manipule pour obtenir un shell avec privileges eleves.

**Identifier les binaires SUID :**
```bash
$ find / -type f -perm -4000 2>/dev/null
```

Resultat typique :
```
/bin/ping
/usr/bin/newgrp
/usr/bin/passwd
/bin/umount
/bin/su
```

Les binaires SUID personnalises (crees par les administrateurs) peuvent introduire des vulnerabilites car ils n'ont pas subi de revue de securite rigoureuse.

---

### Fichiers interessants

Les fichiers peuvent etre interessants pour plusieurs raisons :

| Type | Exemples |
|------|----------|
| **Donnees sensibles** | Bases de donnees, cles API, mots de passe |
| **Configuration** | Fichiers avec identifiants en clair |
| **Historique** | Logs, anciennes sauvegardes |
| **Executables et scripts** | Taches planifiees, scripts de gestion |

**Rechercher des fichiers par extension :**
```bash
$ find / -name '*.conf' 2>/dev/null
```

**Rechercher des fichiers par proprietaire :**
```bash
$ find / -user utilisateur_cible 2>/dev/null
```

**Rechercher "password" dans les fichiers .conf :**
```bash
$ find / -name '*.conf' -exec grep -i 'password' {} + 2>/dev/null
```

**Rechercher recursivement avec grep :**
```bash
$ grep -Ril "password" /etc/ 2>/dev/null
```

**Extraire les chaines lisibles d'un binaire :**
```bash
$ strings binaire | grep 'password'
```

#### Types de fichiers a surveiller

| Fichier/Dossier | Interet |
|-----------------|---------|
| `/var/log` | Logs systeme (auth.log pour les tentatives de connexion) |
| `~/.bash_history` | Historique des commandes (peut contenir des identifiants) |
| Scripts world-writable | Peuvent etre modifies a des fins malveillantes |
| Fichiers `.bak`, `.old`, `.tmp` | Sauvegardes pouvant contenir des donnees sensibles non chiffrees |

**Trouver les fichiers modifiables :**
```bash
$ find / -type f -writable 2>/dev/null
```

---

## Scanners d'elevation de privileges

Les scanners privesc examinent methodiquement un systeme Linux pour trouver des informations et mauvaises configurations permettant une elevation de privileges.

### Fonctionnement

1. **Enumeration systeme** : collecte d'informations sur l'OS, logiciels installes, processus, permissions, variables d'environnement
2. **Identification de vulnerabilites** : croisement avec les vulnerabilites connues
3. **Verification des mauvaises configurations** : fichiers `/etc/passwd` modifiables, sudoers mal configures
4. **Generation de rapport** : vulnerabilites potentielles avec severite et techniques d'exploitation

### Outils principaux

| Outil | Description |
|-------|-------------|
| **LinEnum** | Script leger pour un apercu rapide des faiblesses systeme. Moins intrusif, moins susceptible de declencher des alertes |
| **Linux Exploit Suggester** | Se concentre sur l'identification des exploits possibles pour la version du noyau Linux |
| **LinPEAS** | Enumeration approfondie, activement maintenu. Souvent le premier outil utilise lors d'un test d'intrusion. Peut etre plus lent et fournir beaucoup d'informations |

**Exemple de sortie LinPEAS :**

![Capture d'ecran LinPEAS](assets/linPEAS.png)

---

## Glossaire des sigles et definitions

| Sigle/Terme | Definition |
|-------------|------------|
| **Privilege escalation** | Elevation de privileges - Obtenir des droits superieurs a ceux initialement accordes |
| **Privesc** | Abreviation de privilege escalation |
| **SUID** | Set User ID - Bit permettant l'execution avec les privileges du proprietaire |
| **SGID** | Set Group ID - Bit permettant l'execution avec les privileges du groupe |
| **Zero-day** | Vulnerabilite inconnue du public et du vendeur |
| **Persistence** | Technique pour maintenir l'acces apres un reboot ou une deconnexion |
| **Exfiltration** | Transfert non autorise de donnees hors du systeme |
| **GTFOBins** | Base de donnees de binaires Unix exploitables pour contourner les restrictions |
| **NOPASSWD** | Directive sudo permettant l'execution sans mot de passe |
| **SETENV** | Directive sudo permettant de modifier les variables d'environnement |
| **World-writable** | Fichier modifiable par tous les utilisateurs |
| **Enumeration** | Phase de collecte d'informations sur un systeme cible |
| **Reconnaissance** | Phase initiale d'une attaque visant a collecter des informations |

---

## Recapitulatif des commandes

### Enumeration utilisateurs

| Commande | Description |
|----------|-------------|
| `whoami` | Afficher l'utilisateur courant |
| `id` | Afficher UID, GID et groupes |
| `groups` | Afficher les groupes de l'utilisateur |
| `cat /etc/passwd \| cut -d: -f1` | Lister les noms d'utilisateurs |
| `cat /etc/passwd \| grep "sh$"` | Utilisateurs avec acces shell |
| `awk -F: '($3 == "0") {print}' /etc/passwd` | Trouver les utilisateurs root (UID 0) |
| `who` | Utilisateurs connectes |
| `w` | Utilisateurs connectes avec activite |
| `last -n 5` | 5 dernieres connexions |

### Verification sudo

| Commande | Description |
|----------|-------------|
| `sudo -l` | Lister les commandes autorisees avec sudo |
| `sudo su` | Passer root (si autorise) |
| `cat /etc/sudoers` | Voir la configuration sudo (root requis) |

### Recherche de binaires SUID

| Commande | Description |
|----------|-------------|
| `find / -type f -perm -4000 2>/dev/null` | Trouver les binaires SUID |
| `find / -type f -perm -2000 2>/dev/null` | Trouver les binaires SGID |

### Recherche de fichiers

| Commande | Description |
|----------|-------------|
| `find / -name '*.conf' 2>/dev/null` | Fichiers de configuration |
| `find / -user utilisateur 2>/dev/null` | Fichiers d'un utilisateur |
| `find / -type f -writable 2>/dev/null` | Fichiers modifiables |
| `grep -Ril "password" /etc/` | Rechercher "password" dans /etc |
| `strings binaire \| grep 'password'` | Extraire chaines d'un binaire |

### Detection d'activite malveillante

| Commande | Description |
|----------|-------------|
| `ps aux \| grep '/tmp\|/dev\|/home'` | Executables suspects |
| `ps aux \| grep '[b]ash'` | Processus bash |
| `watch 'ps -eo pid,ppid,cmd --sort=start_time \| tail'` | Surveiller les nouveaux processus |

---

## Ressources

- Linux Privilege Escalation: Exploiting User Groups - Stefano Lanaro
- Gaining Root Access on linux using SUID - Attack Detect Defend (Youtube)
- Linux Privilege Escalation - Hacktricks
- How to use linPEAS - RedBlue Labs (Youtube)
- GTFOBins - gtfobins.github.io
